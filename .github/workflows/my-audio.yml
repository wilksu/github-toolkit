name: YT Multi-Sync to Netease
on:
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch:
    inputs:
      video_id:
        description: 'Manual Video ID'
        required: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python3 -m pip install -U yt-dlp

      - name: Prepare YouTube Cookies
        run: |
          echo "${{ secrets.YT_COOKIE_CONTENT }}" > youtube_cookies.txt

      - name: Random Delay
        run: sleep $(( (RANDOM % 60) + 1 ))

      - name: Download Audio
        run: |
          mkdir -p downloads
          # 基础参数
          YT_OPTS="-x --audio-format mp3 --audio-quality 0 --cookies youtube_cookies.txt --no-warnings"
          
          if [ -n "${{ github.event.inputs.video_id }}" ]; then
            yt-dlp $YT_OPTS -o "downloads/%(title)s.%(ext)s" "https://www.youtube.com/watch?v=${{ github.event.inputs.video_id }}"
          else
            IFS=',' read -ra ADDR <<< "${{ vars.YT_CHANNELS }}"
            for url in "${ADDR[@]}"; do
              yt-dlp $YT_OPTS --dateafter today-26hours -o "downloads/%(title)s.%(ext)s" "$url"
            done
          fi

      - name: Upload to Netease
        run: |
          npm install NeteaseCloudMusicApi
          cat <<EOF > upload.js
          const { cloud_upload } = require('NeteaseCloudMusicApi')
          const fs = require('fs')
          const path = require('path')

          async function main() {
            const dir = './downloads'
            if (!fs.existsSync(dir)) return
            const files = fs.readdirSync(dir).filter(f => f.endsWith('.mp3'))
            
            for (const file of files) {
              const filePath = path.join(dir, file)
              try {
                const res = await cloud_upload({
                  file: { name: file, data: fs.readFileSync(filePath) },
                  cookie: process.env.NETEASE_COOKIE
                })
                console.log(file, 'Result:', res.status)
              } catch (e) {
                console.error(file, 'Failed:', e.message)
              }
            }
          }
          main()
          EOF
          node upload.js
        env:
          NETEASE_COOKIE: ${{ secrets.NETEASE_COOKIE }}

      - name: Cleanup
        run: rm youtube_cookies.txt
