name: YT Multi-Sync to Netease
on:
  schedule:
    - cron: '30 2 * * *'
  workflow_dispatch:
    inputs:
      video_id:
        description: 'Manual Video ID (Optional)'
        required: false

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg
          python3 -m pip install yt-dlp

      - name: Random Delay
        run: sleep $(( (RANDOM % 600) + 1 ))

      - name: Download Audio
        run: |
          mkdir -p downloads
          if [ -n "${{ github.event.inputs.video_id }}" ]; then
            yt-dlp -x --audio-format mp3 --audio-quality 0 -o "downloads/%(title)s.%(ext)s" "https://www.youtube.com/watch?v=${{ github.event.inputs.video_id }}"
          else
            IFS=',' read -ra ADDR <<< "${{ vars.YT_CHANNELS }}"
            for url in "${ADDR[@]}"; do
              yt-dlp -x --audio-format mp3 --audio-quality 0 \
                --dateafter today-26hours \
                -o "downloads/%(title)s.%(ext)s" \
                "$url"
            done
          fi

      - name: Upload to Netease
        run: |
          npm install NeteaseCloudMusicApi
          cat <<EOF > upload.js
          const { cloud_upload } = require('NeteaseCloudMusicApi')
          const fs = require('fs')
          const path = require('path')

          async function main() {
            const dir = './downloads'
            if (!fs.existsSync(dir)) {
              console.log('No files to upload.')
              return
            }
            const files = fs.readdirSync(dir).filter(f => f.endsWith('.mp3'))
            
            for (const file of files) {
              const filePath = path.join(dir, file)
              console.log('Processing:', file)
              try {
                const res = await cloud_upload({
                  file: {
                    name: file,
                    data: fs.readFileSync(filePath)
                  },
                  cookie: process.env.NETEASE_COOKIE
                })
                if (res.status === 200) {
                  console.log('Successfully uploaded:', file)
                } else {
                  console.log('Upload response:', res.status, res.body)
                }
              } catch (e) {
                console.error('Upload failed for:', file, e.message)
              }
            }
          }
          main()
          EOF
          node upload.js
        env:
          NETEASE_COOKIE: ${{ secrets.NETEASE_COOKIE }}
